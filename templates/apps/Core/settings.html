{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    
    {# DEBUG: Tenant bilgisi #}
    {% if not is_admin_panel %}
    <div class="alert alert-info">
        <strong>DEBUG:</strong> 
        Tenant: {{ tenant.name|default:"YOK" }} (ID: {{ tenant.id|default:"YOK" }})
        | Session tenant_id: {{ request.session.tenant_id|default:"YOK" }}
    </div>
    {% endif %}
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-dark">Sistem Yapılandırması</h3>
        <div>
            <a href="?reset=true" class="btn btn-outline-danger me-2">
                <i class="fas fa-sync-alt"></i> Ayarları Sıfırla
            </a>
            <button type="submit" form="settingsForm" class="btn btn-primary px-4" onclick="disableRoleNameField()">
                <i class="fas fa-save me-2"></i> Kaydet
            </button>
        </div>
    </div>

    <form method="post" id="settingsForm">
        {% csrf_token %}
        
        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="list-group sticky-top" style="top: 100px;">
                    <a href="#general" class="list-group-item list-group-item-action active fw-bold py-3" data-bs-toggle="list">Genel Ayarlar</a>
                    <a href="#visit" class="list-group-item list-group-item-action fw-bold py-3" data-bs-toggle="list">Ziyaret & Konum</a>
                    <a href="#user" class="list-group-item list-group-item-action fw-bold py-3" data-bs-toggle="list">Kullanıcı & Personel</a>
                    <a href="#email" class="list-group-item list-group-item-action fw-bold py-3" data-bs-toggle="list">
                        <i class="fas fa-envelope me-2"></i>E-posta Ayarları
                    </a>
                </div>
            </div>

            <div class="col-md-9">
                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="general">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-dark text-white fw-bold">Genel Ayarlar</div>
                            <div class="card-body">
                                {% for setting in settings_general %}
                                    <div class="mb-3 border-bottom pb-3">
                                        <label class="fw-bold d-block">{{ setting.label }}</label>
                                        {% if setting.input_type == 'bool' %}
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" name="{{ setting.key }}" style="width: 3em; height: 1.5em;" {% if setting.value == 'True' %}checked{% endif %}>
                                                <small class="ms-2 text-muted">{{ setting.description }}</small>
                                            </div>
                                        {% elif setting.input_type == 'password' %}
                                            <input type="password" name="{{ setting.key }}" class="form-control" value="{{ setting.value }}" style="max-width: 300px;" placeholder="Şifre girilmiş" autocomplete="new-password">
                                            <small class="text-muted">{{ setting.description }}</small>
                                        {% else %}
                                            <input type="{{ setting.input_type }}" name="{{ setting.key }}" class="form-control" value="{{ setting.value }}" style="max-width: 300px;">
                                            <small class="text-muted">{{ setting.description }}</small>
                                        {% endif %}
                                    </div>
                                {% empty %}
                                    <div class="alert alert-warning">Veri yok! Lütfen yukarıdaki 'Ayarları Sıfırla' butonuna basın.</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="visit">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-warning text-dark fw-bold">Ziyaret & Konum Ayarları</div>
                            <div class="card-body">
                                {% for setting in settings_visit %}
                                    <div class="mb-3 border-bottom pb-3">
                                        <label class="fw-bold d-block">{{ setting.label }}</label>
                                        {% if setting.input_type == 'bool' %}
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" name="{{ setting.key }}" style="width: 3em; height: 1.5em;" {% if setting.value == 'True' %}checked{% endif %}>
                                                <small class="ms-2 text-muted">{{ setting.description }}</small>
                                            </div>
                                        {% elif setting.input_type == 'password' %}
                                            <input type="password" name="{{ setting.key }}" class="form-control" value="{{ setting.value }}" style="max-width: 300px;" placeholder="Şifre girilmiş" autocomplete="new-password">
                                            <small class="text-muted">{{ setting.description }}</small>
                                        {% else %}
                                            <input type="{{ setting.input_type }}" name="{{ setting.key }}" class="form-control" value="{{ setting.value }}" style="max-width: 300px;">
                                            <small class="text-muted">{{ setting.description }}</small>
                                        {% endif %}
                                    </div>
                                {% empty %}
                                    <div class="alert alert-warning">Veri yok! Lütfen yukarıdaki 'Ayarları Sıfırla' butonuna basın.</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="user">
                        <div class="card shadow-sm border-0 mb-3">
                            <div class="card-header bg-info text-white fw-bold">Personel Ayarları</div>
                            <div class="card-body">
                                {% for setting in settings_user %}
                                    <div class="mb-3 border-bottom pb-3">
                                        <label class="fw-bold d-block">{{ setting.label }}</label>
                                        <input type="text" name="{{ setting.key }}" class="form-control" value="{{ setting.value }}">
                                        <small class="text-muted">{{ setting.description }}</small>
                                    </div>
                                {% empty %}
                                    <div class="alert alert-warning">Veri yok! Lütfen yukarıdaki 'Ayarları Sıfırla' butonuna basın.</div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-primary text-white fw-bold">Kullanıcı Rol Ekle/Çıkar</div>
                            <div class="card-body">
                                <form method="post" class="mb-3">
                                    {% csrf_token %}
                                    <div class="d-flex gap-2">
                                        <input type="text" name="role_name" class="form-control" placeholder="Yeni rol adı (örn: Satış Temsilcisi)" required>
                                        <button type="submit" name="add_role" class="btn btn-success">
                                            <i class="fas fa-plus"></i> Ekle
                                        </button>
                                    </div>
                                </form>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Rol Adı</th>
                                                <th class="text-end">İşlem</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for role in user_roles %}
                                            <tr>
                                                <td class="fw-bold">{{ role.name }}</td>
                                                <td class="text-end">
                                                    <form method="post" class="d-inline" onsubmit="return confirm('Bu rolü silmek istediğinize emin misiniz? Bu role atanmış kullanıcıların rolleri kaldırılacak.');">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="role_id" value="{{ role.id }}">
                                                        <button type="submit" name="delete_role" class="btn btn-sm btn-outline-danger">
                                                            <i class="fas fa-trash"></i> Sil
                                                        </button>
                                                    </form>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="2" class="text-center text-muted">Henüz rol eklenmemiş.</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="email">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-success text-white fw-bold">
                                <i class="fas fa-envelope me-2"></i>E-posta Ayarları
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-4">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Bilgi:</strong> 
                                    {% if is_admin_panel %}
                                    Bu ayarlar Rotexia sisteminde kullanılır ve tüm firmalara şablon olarak aktarılır.
                                    {% else %}
                                    Bu ayarlar <strong>{{ tenant.name }}</strong> firmasına özeldir. Otomatik mail gönderimi için SMTP bilgilerinizi buradan yapılandırabilirsiniz.
                                    {% endif %}
                                </div>
                                {% for setting in settings_email %}
                                    <div class="mb-3 border-bottom pb-3">
                                        <label class="fw-bold d-block">{{ setting.label }} {% if setting.key == 'email_host' or setting.key == 'email_host_user' or setting.key == 'email_host_password' %}<span class="text-danger">*</span>{% endif %}</label>
                                        {% if setting.input_type == 'bool' %}
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" name="{{ setting.key }}" style="width: 3em; height: 1.5em;" {% if setting.value == 'True' %}checked{% endif %}>
                                                <small class="ms-2 text-muted">{{ setting.description }}</small>
                                            </div>
                                        {% elif setting.input_type == 'password' %}
                                            <div class="input-group" style="max-width: 400px;">
                                                <input type="password" name="{{ setting.key }}" id="password_{{ setting.key }}" class="form-control" value="{{ setting.value }}" placeholder="Şifre girilmiş" autocomplete="new-password">
                                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('password_{{ setting.key }}', this)" title="Şifreyi göster/gizle">
                                                    <i class="fas fa-eye" id="icon_password_{{ setting.key }}"></i>
                                                </button>
                                            </div>
                                            <small class="text-muted d-block mt-1">{{ setting.description }}</small>
                                        {% else %}
                                            <input type="{{ setting.input_type }}" name="{{ setting.key }}" class="form-control" value="{{ setting.value }}" style="max-width: 400px;" 
                                                   {% if setting.key == 'email_host' %}placeholder="örn: smtp.gmail.com, smtp-mail.outlook.com, smtp.office365.com" 
                                                   pattern="smtp\.[a-zA-Z0-9.-]+" 
                                                   title="SMTP sunucu adresi giriniz (örn: smtp.gmail.com). Email adresi değil, sunucu adresi olmalıdır!"{% elif setting.key == 'email_host_user' %}placeholder="örn: noreply@yourdomain.com, rotexiaapp@hotmail.com"{% endif %}>
                                            <small class="text-muted d-block mt-1">
                                                {{ setting.description }}
                                                {% if setting.key == 'email_host' %}
                                                <br><strong class="text-danger">⚠️ ÖNEMLİ:</strong> Bu alana email adresi DEĞİL, SMTP sunucu adresi girmelisiniz!
                                                <br>• Gmail için: <code>smtp.gmail.com</code>
                                                <br>• Hotmail/Outlook için: <code>smtp-mail.outlook.com</code> veya <code>smtp.office365.com</code>
                                                <br>• Diğer sunucular için: <code>smtp.sizin-sunucunuz.com</code>
                                                {% endif %}
                                            </small>
                                        {% endif %}
                                    </div>
                                {% empty %}
                                    <div class="alert alert-warning">E-posta ayarları henüz oluşturulmamış. Lütfen 'Ayarları Sıfırla' butonuna basın.</div>
                                {% endfor %}
                                <div class="alert alert-warning mt-4">
                                    <strong><i class="fas fa-key me-2"></i>Önemli: App Password (Uygulama Şifresi) Kullanın!</strong>
                                    <hr>
                                    <div class="mb-3">
                                        <strong class="text-danger">⚠️ Hotmail/Outlook kullanıcıları:</strong>
                                        <ol class="mb-0 mt-2">
                                            <li>Hotmail/Outlook hesabınızda <strong>2-Factor Authentication'ı açın</strong></li>
                                            <li><a href="https://account.microsoft.com/security/app-passwords" target="_blank" class="text-primary"><i class="fas fa-external-link-alt me-1"></i>Microsoft App Password oluşturun</a></li>
                                            <li>Oluşan <strong>16 haneli şifreyi</strong> "SMTP Şifresi" alanına girin</li>
                                            <li class="text-danger"><strong>ÖNEMLİ:</strong> Normal şifrenizi DEĞİL, App Password'ü kullanın!</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <strong class="text-info">ℹ️ Gmail kullanıcıları:</strong>
                                        <ol class="mb-0 mt-2">
                                            <li>Google hesabınızda 2 adımlı doğrulamayı açın</li>
                                            <li><a href="https://myaccount.google.com/apppasswords" target="_blank" class="text-primary"><i class="fas fa-external-link-alt me-1"></i>Google App Password oluşturun</a></li>
                                            <li>Oluşan 16 haneli şifreyi "SMTP Şifresi" alanına girin</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </form>
</div>

<script>
function disableRoleNameField() {
    // Ana form submit edilirken role_name field'ını disable et
    // Böylece HTML5 validation bu field'ı kontrol etmez
    const roleNameInput = document.querySelector('input[name="role_name"]');
    if (roleNameInput) {
        roleNameInput.removeAttribute('required');
        roleNameInput.disabled = true;
    }
}

// Şifre göster/gizle fonksiyonu
function togglePassword(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById('icon_' + inputId);
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
        button.setAttribute('title', 'Şifreyi gizle');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
        button.setAttribute('title', 'Şifreyi göster');
    }
}

// Form submit edildikten sonra tekrar aktif et (geri dönüş için)
document.addEventListener('DOMContentLoaded', function() {
    const settingsForm = document.getElementById('settingsForm');
    if (settingsForm) {
        settingsForm.addEventListener('submit', function() {
            disableRoleNameField();
        });
    }
});
</script>

{% endblock %}

 