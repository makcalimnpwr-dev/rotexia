{% extends 'base_mobile.html' %}
{% block header_title %}Profil{% endblock %}

{% block content %}
<div class="card app-card text-center p-4 mb-3">
    <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=0d6efd&color=fff&size=80" class="rounded-circle mb-3 mx-auto">
    <h5 class="fw-bold">{{ user.first_name }} {{ user.last_name }}</h5>
    <p class="text-muted small">{{ user.user_code }}</p>
</div>

<div class="card app-card p-4 mb-3">
    <h6 class="fw-bold mb-3"><i class="fas fa-cog me-2"></i>Ayarlar</h6>
    
    <button type="button" id="syncDataBtn" class="btn btn-primary w-100 rounded-pill fw-bold mb-3">
        <i class="fas fa-sync-alt me-2"></i> Veri Paylaş
    </button>
    <small class="text-muted d-block text-center">Bekleyen form verilerini hemen gönder</small>
    
    <div id="syncStatus" class="mt-3 text-center" style="display:none;">
        <small class="text-success" id="syncSuccess" style="display:none;">
            <i class="fas fa-check-circle"></i> Veriler gönderildi
        </small>
        <small class="text-danger" id="syncError" style="display:none;">
            <i class="fas fa-exclamation-circle"></i> Hata oluştu
        </small>
    </div>
</div>

<div class="card app-card p-4">
    <form action="{% url 'logout' %}" method="post">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger w-100 rounded-pill fw-bold">
            <i class="fas fa-sign-out-alt me-2"></i> Güvenli Çıkış
        </button>
    </form>
</div>

<script>
document.getElementById('syncDataBtn').addEventListener('click', async function() {
    const btn = this;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Gönderiliyor...';
    
    // localStorage'dan bekleyen form verilerini al
    const pendingForms = JSON.parse(localStorage.getItem('pending_forms') || '[]');
    
    if (pendingForms.length === 0) {
        document.getElementById('syncSuccess').innerHTML = '<i class="fas fa-check-circle"></i> Bekleyen veri yok';
        document.getElementById('syncSuccess').style.display = 'block';
        document.getElementById('syncError').style.display = 'none';
        document.getElementById('syncStatus').style.display = 'block';
        setTimeout(() => {
            document.getElementById('syncStatus').style.display = 'none';
        }, 3000);
        btn.disabled = false;
        btn.innerHTML = originalText;
        return;
    }
    
    // Bekleyen form verilerini gönder
    try {
        const response = await fetch('{% url "mobile_sync_pending_data" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ pending_forms: pendingForms })
        });
        
        const data = await response.json();
        if (data.success) {
            // Başarılı gönderilen formları localStorage'dan sil
            localStorage.removeItem('pending_forms');
            document.getElementById('syncSuccess').innerHTML = `<i class="fas fa-check-circle"></i> ${data.success_count} form gönderildi`;
            document.getElementById('syncSuccess').style.display = 'block';
            document.getElementById('syncError').style.display = 'none';
            document.getElementById('syncStatus').style.display = 'block';
            setTimeout(() => {
                document.getElementById('syncStatus').style.display = 'none';
            }, 3000);
        } else {
            document.getElementById('syncSuccess').style.display = 'none';
            document.getElementById('syncError').innerHTML = `<i class="fas fa-exclamation-circle"></i> ${data.message || 'Hata oluştu'}`;
            document.getElementById('syncError').style.display = 'block';
            document.getElementById('syncStatus').style.display = 'block';
        }
        btn.disabled = false;
        btn.innerHTML = originalText;
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('syncSuccess').style.display = 'none';
        document.getElementById('syncError').innerHTML = '<i class="fas fa-exclamation-circle"></i> Bağlantı hatası';
        document.getElementById('syncError').style.display = 'block';
        document.getElementById('syncStatus').style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
});
</script>
{% endblock %}