{% extends 'base_mobile.html' %}

{% block content %}
{% if has_team %}
<div class="px-3 pt-2">
  <div class="btn-group w-100" role="group" aria-label="Sekmeler">
    <a href="{% url 'mobile_home' %}" class="btn btn-outline-primary">Benim</a>
    <a href="{% url 'mobile_team_home' %}" class="btn btn-primary">Ekip</a>
  </div>
</div>
{% endif %}

{% if is_root_admin_view and viewing_as %}
<div class="px-3 pt-2">
  <div class="alert alert-info py-2 px-3 mb-2" style="border-radius: 14px;">
    <div class="d-flex justify-content-between align-items-center">
      <div class="small">
        <strong>Görüntülenen:</strong>
        {{ viewing_as.first_name }} {{ viewing_as.last_name }} ({{ viewing_as.username }})
      </div>
      <a class="btn btn-sm btn-outline-primary" href="{% url 'mobile_team_home' %}">Üste dön</a>
    </div>
  </div>
</div>
{% endif %}

<div class="hero-card">
    <a href="#" class="btn-break-hero" id="breakBtn" onclick="toggleBreak(); return false;">
        <span id="breakTimer" class="break-timer d-none">00:00:00</span>
        <i class="fas fa-mug-hot"></i>
        <span id="breakBtnText">Mola</span>
    </a>

    <div class="progress-ring" style="--prog: {{ team_progress_percentage }}%;">
        <div class="progress-text">
            <div class="percent-val">%{{ team_progress_percentage }}</div>
            <div class="percent-label">Ekip Tamamlandı</div>
        </div>
    </div>
    
    <div class="d-flex justify-content-between mt-4 text-center">
        <div>
            <h4 class="m-0 fw-bold">{{ team_completed_tasks }}</h4>
            <small class="text-white-50" style="font-size: 11px;">TAMAMLANAN</small>
        </div>
        <div>
            <h4 class="m-0 fw-bold">{{ team_total_tasks }}</h4>
            <small class="text-white-50" style="font-size: 11px;">TOPLAM HEDEF</small>
        </div>
    </div>
</div>

<div class="section-title">Ekip</div>

<div class="px-3 pb-4">
  {% for m in team %}
  <div class="card shadow-sm border-0 mb-2" style="border-radius: 16px;">
    <div class="card-body d-flex align-items-center justify-content-between">
      <div class="me-2">
        <div class="fw-bold">{{ m.name }}</div>
        <div class="text-muted small">{{ m.merch_code }} • {{ m.authority }}</div>
        <div class="mt-1 small">
          <span class="fw-bold">{{ m.completed }}</span>/<span class="fw-bold">{{ m.total }}</span>
          <span class="text-muted">Mağaza Tamamlama</span>
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">
        {% if m.location_url %}
          <a class="btn btn-outline-secondary btn-sm" href="{{ m.location_url }}" target="_blank" title="Konum">
            <i class="fas fa-location-dot"></i>
          </a>
        {% else %}
          <button class="btn btn-outline-secondary btn-sm" disabled title="Konum yok">
            <i class="fas fa-location-dot"></i>
          </button>
        {% endif %}

        {% if is_root_admin_view and m.drill_as_user_id %}
          <a class="btn btn-primary btn-sm" href="{% url 'mobile_team_home' %}?as_user={{ m.drill_as_user_id }}">
            <i class="fas fa-sitemap"></i>
          </a>
        {% else %}
          <a class="btn btn-primary btn-sm" href="{% url 'mobile_team_member' m.merch_code %}">
            <i class="fas fa-chevron-right"></i>
          </a>
        {% endif %}
      </div>
    </div>
  </div>
  {% empty %}
  <div class="text-center p-5 text-muted">
    <i class="fas fa-users fa-3x mb-3 opacity-25"></i>
    <p>Hiyerarşide altınızda kullanıcı yok.</p>
  </div>
  {% endfor %}
</div>

<script>
  // --- MOLA (Sayaç + Engelleme) ---
  let breakInterval = null;

  function formatDuration(ms) {
      const totalSeconds = Math.max(0, Math.floor(ms / 1000));
      const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
      const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
      const s = String(totalSeconds % 60).padStart(2, '0');
      return `${h}:${m}:${s}`;
  }

  function isBreakActive() { return localStorage.getItem('breakActive') === 'true'; }
  function getBreakStartedAt() {
      const v = localStorage.getItem('breakStartedAt');
      const n = v ? parseInt(v, 10) : NaN;
      return Number.isFinite(n) ? n : null;
  }
  function getBreakLastMs() {
      const v = localStorage.getItem('breakLastMs');
      const n = v ? parseInt(v, 10) : NaN;
      return Number.isFinite(n) ? n : null;
  }

  function renderBreakUI() {
      const btn = document.getElementById('breakBtn');
      const btnText = document.getElementById('breakBtnText');
      const timerEl = document.getElementById('breakTimer');
      if (!btn || !btnText || !timerEl) return;

      if (isBreakActive()) {
          btn.classList.add('break-active');
          btnText.textContent = 'Mola Bitir';
          timerEl.classList.remove('d-none');
          timerEl.classList.remove('inactive');
      } else {
          btn.classList.remove('break-active');
          btnText.textContent = 'Mola';
          const last = getBreakLastMs();
          if (last !== null) {
              timerEl.classList.remove('d-none');
              timerEl.classList.add('inactive');
              timerEl.textContent = formatDuration(last);
          } else {
              timerEl.classList.add('d-none');
              timerEl.textContent = '00:00:00';
          }
      }
  }

  function startBreakTimer() {
      if (breakInterval) clearInterval(breakInterval);
      const timerEl = document.getElementById('breakTimer');
      const startedAt = getBreakStartedAt();
      if (!timerEl || !startedAt) return;
      timerEl.textContent = formatDuration(Date.now() - startedAt);
      breakInterval = setInterval(() => {
          const elapsed = Date.now() - startedAt;
          timerEl.textContent = formatDuration(elapsed);
      }, 1000);
  }

  function stopBreakTimer() {
      if (breakInterval) { clearInterval(breakInterval); breakInterval = null; }
  }

  function toggleBreak() {
      if (isBreakActive()) {
          const startedAt = getBreakStartedAt();
          if (startedAt) localStorage.setItem('breakLastMs', String(Date.now() - startedAt));
          localStorage.removeItem('breakActive');
          localStorage.removeItem('breakStartedAt');
          stopBreakTimer();
          renderBreakUI();
          if (typeof Swal !== 'undefined') Swal.fire({ icon: 'success', title: 'Mola Bitti', timer: 900, showConfirmButton: false });
      } else {
          localStorage.setItem('breakActive', 'true');
          localStorage.setItem('breakStartedAt', String(Date.now()));
          localStorage.removeItem('breakLastMs');
          renderBreakUI();
          startBreakTimer();
          if (typeof Swal !== 'undefined') Swal.fire({ icon: 'info', title: 'Mola Başladı', text: 'Mola bitene kadar ziyaret başlatamazsınız.', timer: 1400, showConfirmButton: false });
      }
  }

  document.addEventListener('DOMContentLoaded', function() {
      renderBreakUI();
      if (isBreakActive()) startBreakTimer();
  });
</script>
{% endblock %}


